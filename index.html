<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ポモドーロタイマー（時間設定＋ネオンブルー）</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #0a0f1e, #000);
    color: #e0f7fa;
    text-align: center;
    padding: 20px;
  }
  h1 { text-shadow: 0 0 10px #00e5ff; }
  textarea, input {
    width: 80%;
    padding: 8px;
    margin: 5px 0;
    border-radius: 8px;
    border: 1px solid rgba(0, 229, 255, 0.5);
    background: rgba(255,255,255,0.05);
    color: #e0f7fa;
  }
  button {
    padding: 10px 16px;
    margin: 5px;
    border-radius: 8px;
    border: 1px solid rgba(0, 229, 255, 0.5);
    background: rgba(0,229,255,0.1);
    color: #e0f7fa;
    cursor: pointer;
  }
  button:hover:not(:disabled) { background: rgba(0,229,255,0.2); }
  button:disabled { opacity: 0.4; }
  #timer {
    font-size: 72px;
    margin: 20px 0;
    font-weight: bold;
    color: #00e5ff;
    text-shadow: 0 0 20px #00e5ff;
  }
  table { border-collapse: collapse; width: 90%; margin: 20px auto; }
  th, td { border: 1px solid rgba(0,229,255,0.3); padding: 6px; }
  th { background: rgba(0,229,255,0.2); }
</style>
</head>
<body>

<h1>ポモドーロタイマー</h1>

<label>作業時間（分）：<input id="workMinutes" type="number" value="25" min="1"></label>
<label>休憩時間（分）：<input id="breakMinutes" type="number" value="5" min="1"></label>

<h3>目標入力</h3>
<textarea id="goal" rows="2" placeholder="今回の作業目標を入力してください"></textarea><br>
<button id="lockGoal">🔒 目標をロック</button>

<div id="timer">25:00</div>
<button id="startPause" disabled>▶ 開始</button>
<button id="reset">⟲ リセット</button>

<h3>進捗メモ（作業終了後に入力）</h3>
<textarea id="progress" rows="2" placeholder="作業終了後に進捗を記入してください" disabled></textarea><br>
<button id="saveProgress" disabled>💾 保存して休憩開始</button>

<h3>履歴</h3>
<table id="historyTable">
  <thead><tr><th>日時</th><th>目標</th><th>進捗</th></tr></thead>
  <tbody></tbody>
</table>
<button id="downloadCSV">⬇ CSVダウンロード</button>
<button id="clearHistory">🗑 履歴を全消去</button>

<script>
// ==== オーディオ（Web Audio API）====
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if(audioCtx.state === 'suspended') audioCtx.resume();
}
function playEndMelody(){
  if(!audioCtx) return;
  const now = audioCtx.currentTime;
  const notes = [523.25, 659.25, 783.99];
  const step = 0.12;
  const g1 = audioCtx.createGain(); g1.connect(audioCtx.destination);
  g1.gain.setValueAtTime(0.0001, now);
  notes.forEach((f,i)=>{
    const o=audioCtx.createOscillator(); o.type='sine'; o.frequency.value=f; o.connect(g1);
    const t=now+i*step;
    g1.gain.exponentialRampToValueAtTime(0.3, t+0.01);
    g1.gain.exponentialRampToValueAtTime(0.05, t+step-0.02);
    o.start(t); o.stop(t+step);
  });
  const chordStart = now + notes.length*step + 0.05;
  [523.25,659.25,880.0].forEach(f=>{
    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type='triangle'; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.0001, chordStart);
    g.gain.exponentialRampToValueAtTime(0.25, chordStart+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, chordStart+0.25);
    o.start(chordStart); o.stop(chordStart+0.27);
  });
}

// ==== タイマー ====
let timeLeft;
let breakTime;
let timerInterval;
let isRunning = false;
let mode = 'work';
let lockedGoal = '';

const timerDisplay = document.getElementById('timer');
const startPauseBtn = document.getElementById('startPause');
const goalInput = document.getElementById('goal');
const lockGoalBtn = document.getElementById('lockGoal');
const progressInput = document.getElementById('progress');
const saveProgressBtn = document.getElementById('saveProgress');

function updateDisplay() {
  let min = String(Math.floor(timeLeft / 60)).padStart(2,'0');
  let sec = String(timeLeft % 60).padStart(2,'0');
  timerDisplay.textContent = `${min}:${sec}`;
}

function startPauseTimer() {
  if (!isRunning) {
    timerInterval = setInterval(() => {
      timeLeft--;
      updateDisplay();
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        isRunning = false;
        playEndMelody();
        if (mode === 'work') {
          progressInput.disabled = false;
          saveProgressBtn.disabled = false;
          startPauseBtn.disabled = true;
        } else {
          mode = 'work';
          timeLeft = parseInt(document.getElementById('workMinutes').value,10) * 60;
          goalInput.disabled = false;
          goalInput.value = '';
          lockGoalBtn.disabled = false;
          lockedGoal = '';
          startPauseBtn.disabled = true;
          progressInput.value = '';
          progressInput.disabled = true;
          saveProgressBtn.disabled = true;
        }
      }
    }, 1000);
    isRunning = true;
    startPauseBtn.textContent = '⏸ 一時停止';
  } else {
    clearInterval(timerInterval);
    isRunning = false;
    startPauseBtn.textContent = '▶ 開始';
  }
}

function resetTimer() {
  clearInterval(timerInterval);
  isRunning = false;
  mode = 'work';
  timeLeft = parseInt(document.getElementById('workMinutes').value,10) * 60;
  updateDisplay();
  startPauseBtn.textContent = '▶ 開始';
  goalInput.disabled = false;
  lockGoalBtn.disabled = false;
  startPauseBtn.disabled = true;
  progressInput.disabled = true;
  saveProgressBtn.disabled = true;
}

lockGoalBtn.onclick = () => {
  lockedGoal = goalInput.value.trim();
  if (!lockedGoal) { alert('目標を入力してください'); return; }
  goalInput.disabled = true;
  lockGoalBtn.disabled = true;
  startPauseBtn.disabled = false;
};

startPauseBtn.addEventListener('click', () => {
  ensureAudio();
  startPauseTimer();
});
document.getElementById('reset').onclick = resetTimer;

saveProgressBtn.onclick = () => {
  let progress = progressInput.value.trim();
  let history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
  history.push([new Date().toLocaleString(), lockedGoal, progress]);
  localStorage.setItem('pomodoroHistory', JSON.stringify(history));
  renderHistory();
  mode = 'break';
  timeLeft = parseInt(document.getElementById('breakMinutes').value,10) * 60;
  progressInput.disabled = true;
  saveProgressBtn.disabled = true;
  startPauseBtn.disabled = false;
  startPauseTimer();
};

function renderHistory() {
  let tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  let history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
  history.forEach(row => {
    let tr = document.createElement('tr');
    row.forEach(cell => {
      let td = document.createElement('td');
      td.textContent = cell;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

document.getElementById('downloadCSV').onclick = () => {
  const history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
  const rows = [['日時','目標','進捗'], ...history];
  const csvBody = rows.map(r => r.map(x => `"${String(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csvBody], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pomodoro_history.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 0);
};

document.getElementById('clearHistory').onclick = () => {
  if (confirm('履歴を全て削除しますか？')) {
    localStorage.removeItem('pomodoroHistory');
    renderHistory();
  }
};

timeLeft = parseInt(document.getElementById('workMinutes').value,10) * 60;
renderHistory();
updateDisplay();
</script>

</body>
</html>
