<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼ï¼ˆæ™‚é–“è¨­å®šï¼‹å³åæ˜ ï¼‹ãƒã‚ªãƒ³ãƒ–ãƒ«ãƒ¼ï¼‰</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0a0f1e, #000); color: #e0f7fa; text-align: center; padding: 20px; }
  h1 { margin-bottom: 10px; text-shadow: 0 0 10px #00e5ff; }
  textarea, input { width: 80%; padding: 8px; margin: 5px 0; border-radius: 8px; border: 1px solid rgba(0, 229, 255, 0.5); background: rgba(255,255,255,0.05); color: #e0f7fa; }
  button { padding: 10px 16px; margin: 5px; border-radius: 8px; border: 1px solid rgba(0, 229, 255, 0.5); background: rgba(0,229,255,0.1); color: #e0f7fa; cursor: pointer; }
  button:hover:not(:disabled) { background: rgba(0,229,255,0.2); }
  button:disabled { opacity: .4; cursor: not-allowed; }
  #timer { font-size: 72px; margin: 20px 0; font-weight: bold; color: #00e5ff; text-shadow: 0 0 20px #00e5ff; }
  table { border-collapse: collapse; width: 90%; margin: 20px auto; }
  th, td { border: 1px solid rgba(0,229,255,.3); padding: 6px; font-size: 14px; }
  th { background: rgba(0,229,255,.2); }
</style>
</head>
<body>

<h1>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼</h1>

<!-- æ™‚é–“è¨­å®š -->
<div>
  <label>ä½œæ¥­æ™‚é–“ï¼ˆåˆ†ï¼‰ï¼š<input id="workMinutes" type="number" value="25" min="1" max="180"></label>
  <label>ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰ï¼š<input id="breakMinutes" type="number" value="5"  min="1" max="60"></label>
  <button id="applySettings">âš™ï¸ è¨­å®šã‚’åæ˜ </button>
</div>

<h3>ç›®æ¨™å…¥åŠ›</h3>
<textarea id="goal" rows="2" placeholder="ä»Šå›ã®ä½œæ¥­ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea><br>
<button id="lockGoal">ğŸ”’ ç›®æ¨™ã‚’ãƒ­ãƒƒã‚¯</button>

<div id="timer">25:00</div>
<button id="startPause" disabled>â–¶ é–‹å§‹</button>
<button id="reset">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>

<h3>é€²æ—ãƒ¡ãƒ¢ï¼ˆä½œæ¥­çµ‚äº†å¾Œã«å…¥åŠ›ï¼‰</h3>
<textarea id="progress" rows="2" placeholder="ä½œæ¥­çµ‚äº†å¾Œã«é€²æ—ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„" disabled></textarea><br>
<button id="saveProgress" disabled>ğŸ’¾ ä¿å­˜ã—ã¦ä¼‘æ†©é–‹å§‹</button>

<h3>å±¥æ­´</h3>
<table id="historyTable">
  <thead><tr><th>æ—¥æ™‚</th><th>ç›®æ¨™</th><th>é€²æ—</th></tr></thead>
  <tbody></tbody>
</table>
<button id="downloadCSV">â¬‡ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
<button id="clearHistory">ğŸ—‘ å±¥æ­´ã‚’å…¨æ¶ˆå»</button>

<script>
// ==== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªï¼ˆWeb Audio APIï¼‰====
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if(audioCtx.state === 'suspended') audioCtx.resume();
}
function playEndMelody(){
  if(!audioCtx) return;
  const now = audioCtx.currentTime;
  const notes = [523.25, 659.25, 783.99]; // C5 E5 G5
  const step = 0.12;
  const g1 = audioCtx.createGain(); g1.connect(audioCtx.destination);
  g1.gain.setValueAtTime(0.0001, now);
  notes.forEach((f,i)=>{
    const o=audioCtx.createOscillator(); o.type='sine'; o.frequency.value=f; o.connect(g1);
    const t=now+i*step;
    g1.gain.exponentialRampToValueAtTime(0.3, t+0.01);
    g1.gain.exponentialRampToValueAtTime(0.05, t+step-0.02);
    o.start(t); o.stop(t+step);
  });
  const chordStart = now + notes.length*step + 0.05;
  [523.25,659.25,880.0].forEach(f=>{
    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type='triangle'; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.0001, chordStart);
    g.gain.exponentialRampToValueAtTime(0.25, chordStart+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, chordStart+0.25);
    o.start(chordStart); o.stop(chordStart+0.27);
  });
}

// ==== ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ ====
let timerInterval;
let isRunning = false;
let mode = 'work'; // 'work' or 'break'
let lockedGoal = '';

const workInput  = document.getElementById('workMinutes');
const breakInput = document.getElementById('breakMinutes');
const applyBtn   = document.getElementById('applySettings');

let workSecs  = clampInt(parseInt(workInput.value,10), 1, 180) * 60;
let breakSecs = clampInt(parseInt(breakInput.value,10), 1, 60) * 60;
let timeLeft  = workSecs;

// ==== è¦ç´  ====
const timerDisplay   = document.getElementById('timer');
const startPauseBtn  = document.getElementById('startPause');
const goalInput      = document.getElementById('goal');
const lockGoalBtn    = document.getElementById('lockGoal');
const progressInput  = document.getElementById('progress');
const saveProgressBtn= document.getElementById('saveProgress');

// ==== å…±é€š ====
function clampInt(n, min, max){
  n = isFinite(n) ? Math.floor(n) : min;
  return Math.max(min, Math.min(max, n));
}
function updateDisplay() {
  const m = String(Math.floor(timeLeft/60)).padStart(2,'0');
  const s = String(timeLeft%60).padStart(2,'0');
  timerDisplay.textContent = `${m}:${s}`;
}

// ==== ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡ ====
function startPauseTimer() {
  if (!isRunning) {
    timerInterval = setInterval(() => {
      timeLeft--;
      updateDisplay();
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        isRunning = false;
        playEndMelody();
        if (mode === 'work') {
          // ä½œæ¥­çµ‚äº† â†’ é€²æ—å…¥åŠ›ã¸
          progressInput.disabled = false;
          saveProgressBtn.disabled = false;
          startPauseBtn.disabled = true;
        } else {
          // ä¼‘æ†©çµ‚äº† â†’ ä½œæ¥­æº–å‚™ã¸
          mode = 'work';
          timeLeft = workSecs;
          goalInput.disabled = false; goalInput.value = '';
          lockGoalBtn.disabled = false; lockedGoal = '';
          startPauseBtn.disabled = true;
          progressInput.value = ''; progressInput.disabled = true; saveProgressBtn.disabled = true;
          updateDisplay();
        }
      }
    }, 1000);
    isRunning = true;
    startPauseBtn.textContent = 'â¸ ä¸€æ™‚åœæ­¢';
  } else {
    clearInterval(timerInterval);
    isRunning = false;
    startPauseBtn.textContent = 'â–¶ é–‹å§‹';
  }
}

function resetTimer() {
  clearInterval(timerInterval);
  isRunning = false;
  mode = 'work';
  timeLeft = workSecs;
  updateDisplay();
  startPauseBtn.textContent = 'â–¶ é–‹å§‹';
  goalInput.disabled = false;
  lockGoalBtn.disabled = false;
  startPauseBtn.disabled = true;
  progressInput.disabled = true;
  saveProgressBtn.disabled = true;
}

// ==== ç›®æ¨™ãƒ­ãƒƒã‚¯ ====
lockGoalBtn.onclick = () => {
  lockedGoal = goalInput.value.trim();
  if (!lockedGoal) { alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  goalInput.disabled = true;
  lockGoalBtn.disabled = true;
  startPauseBtn.disabled = false;
};

// ==== é–‹å§‹/åœæ­¢ ====
startPauseBtn.addEventListener('click', () => {
  ensureAudio();  // è‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯å¯¾ç­–
  startPauseTimer();
});
document.getElementById('reset').onclick = resetTimer;

// ==== è¨­å®šã‚’åæ˜ ï¼ˆå³æ™‚ï¼‰ ====
applyBtn.onclick = () => {
  // å…¥åŠ›å€¤ã‚’å®‰å…¨ã«å–å¾—
  const newWorkMin  = clampInt(parseInt(workInput.value, 10), 1, 180);
  const newBreakMin = clampInt(parseInt(breakInput.value,10), 1, 60);
  // å…¥åŠ›æ¬„ã«è£œæ­£å¾Œã®å€¤ã‚’æˆ»ã™
  workInput.value  = newWorkMin;
  breakInput.value = newBreakMin;

  const prevWork  = workSecs;
  const prevBreak = breakSecs;
  const prevLeft  = timeLeft;

  // æ–°ã—ã„ç·æ™‚é–“ï¼ˆç§’ï¼‰ã«æ›´æ–°
  workSecs  = newWorkMin  * 60;
  breakSecs = newBreakMin * 60;

  // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ã€ŒçµŒéæ™‚é–“ã€ã‚’ä¿ã£ãŸã¾ã¾æ®‹ã‚Šã‚’å†è¨ˆç®—
  if (mode === 'work') {
    const elapsed = Math.max(0, prevWork - prevLeft);
    timeLeft = Math.max(0, workSecs - elapsed);
  } else {
    const elapsed = Math.max(0, prevBreak - prevLeft);
    timeLeft = Math.max(0, breakSecs - elapsed);
  }
  updateDisplay();
};

// ==== é€²æ—ä¿å­˜ â†’ ä¼‘æ†©é–‹å§‹ ====
saveProgressBtn.onclick = () => {
  const progress = progressInput.value.trim();
  const history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
  history.push([new Date().toLocaleString(), lockedGoal, progress]);
  localStorage.setItem('pomodoroHistory', JSON.stringify(history));
  renderHistory();

  // ä¼‘æ†©é–‹å§‹
  mode = 'break';
  timeLeft = breakSecs;
  progressInput.disabled = true; saveProgressBtn.disabled = true;
  startPauseBtn.disabled = false;
  startPauseTimer();
};

// ==== å±¥æ­´ & CSV ====
function renderHistory() {
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  const history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
  history.forEach(row => {
    const tr = document.createElement('tr');
    row.forEach(cell => { const td = document.createElement('td'); td.textContent = cell; tr.appendChild(td); });
    tbody.appendChild(tr);
  });
}
document.getElementById('downloadCSV').onclick = () => {
  try {
    const history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
    const rows = [['æ—¥æ™‚','ç›®æ¨™','é€²æ—'], ...history];
    if (rows.length === 1) {
      if (!confirm('å±¥æ­´ãŒç©ºã§ã™ã€‚ç©ºã®CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) return;
    }
    const csvBody = rows.map(r => r.map(x => `"${String(x ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvBody], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'pomodoro_history.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 0);
  } catch (e) {
    console.error('CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—:', e);
    alert('CSVã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å±¥æ­´ã«1ä»¶è¿½åŠ ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
  }
};
document.getElementById('clearHistory').onclick = () => {
  if (confirm('å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('pomodoroHistory'); renderHistory(); }
};

// ==== åˆæœŸè¡¨ç¤º ====
updateDisplay();
renderHistory();
</script>

</body>
</html>
